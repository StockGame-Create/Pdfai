<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Firebase 채팅 - 방 생성/입장</title>
  <style>
    #chat {
      width: 90%;
      height: 300px;
      border: 1px solid #ccc;
      overflow-y: auto;
      margin: 10px auto;
      padding: 5px;
    }
    #input, #sendBtn { font-size: 1rem; }
    #input { width: 75%; }
  </style>
</head>
<body>
  <h2>Firebase 채팅</h2>

  <button id="createBtn">방 생성</button>
  <input id="joinRoomInput" placeholder="입장할 방 ID 입력" />
  <button id="joinBtn">방 입장</button>
  <p>현재 방 ID: <span id="roomIdDisplay">없음</span></p>

  <div id="chat"></div>
  <input id="input" placeholder="메시지 입력" />
  <button id="sendBtn">전송</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      get,
      onChildAdded
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD9qLLToWFFiMKsUNH-DxPLj-ceFVP8Rxg",
      authDomain: "amazi-6de63.firebaseapp.com",
      databaseURL: "https://amazi-6de63-default-rtdb.firebaseio.com",
      projectId: "amazi-6de63",
      storageBucket: "amazi-6de63.appspot.com",
      messagingSenderId: "274825287462",
      appId: "1:274825287462:web:1b1de31d93d7a3e83693e7",
      measurementId: "G-DT4JLH8QEC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const createBtn = document.getElementById('createBtn');
    const joinBtn = document.getElementById('joinBtn');
    const joinRoomInput = document.getElementById('joinRoomInput');
    const roomIdDisplay = document.getElementById('roomIdDisplay');
    const chatDiv = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');

    let chatRef = null;
    let roomId = null;

    function generateRoomId() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function scrollChatToBottom() {
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    async function createRoom() {
      roomId = generateRoomId();
      roomIdDisplay.textContent = roomId;

      const roomRef = ref(db, 'rooms/' + roomId);
      const chatPath = 'chats/' + roomId;
      chatRef = ref(db, chatPath);

      // ✅ 방 정보를 rooms/{roomId}에 등록
      await set(roomRef, {
        createdAt: Date.now()
      });

      alert(`방이 생성되었습니다. 방 ID: ${roomId}`);
      listenToChat();
      createBtn.disabled = true;
      joinBtn.disabled = true;
      joinRoomInput.disabled = true;
    }

    async function joinRoom() {
      const inputRoomId = joinRoomInput.value.trim().toUpperCase();
      if (!inputRoomId) {
        alert("입장할 방 ID를 입력하세요.");
        return;
      }

      const roomSnap = await get(ref(db, 'rooms/' + inputRoomId));
      if (!roomSnap.exists()) {
        alert("❌ 해당 방이 존재하지 않습니다.");
        return;
      }

      roomId = inputRoomId;
      roomIdDisplay.textContent = roomId;
      chatRef = ref(db, 'chats/' + roomId);

      alert(`방 '${roomId}'에 입장하였습니다.`);
      listenToChat();

      createBtn.disabled = true;
      joinBtn.disabled = true;
      joinRoomInput.disabled = true;
    }

    function listenToChat() {
      onChildAdded(chatRef, snapshot => {
        const val = snapshot.val();
        if (val && val.name && val.msg) {
          chatDiv.innerHTML += `<div><b>${val.name}:</b> ${val.msg}</div>`;
          scrollChatToBottom();
        }
      });
    }

    sendBtn.onclick = () => {
      if (!chatRef) {
        alert("방을 먼저 생성하거나 입장하세요.");
        return;
      }

      const name = prompt("이름을 입력하세요") || "익명";
      const msg = input.value.trim();
      if (msg) {
        push(chatRef, { name, msg });
        input.value = '';
      }
    };

    createBtn.onclick = createRoom;
    joinBtn.onclick = joinRoom;
  </script>
</body>
</html>
