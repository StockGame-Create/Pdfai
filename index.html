<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>10분 자유토론(Firebase)</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    #video { width: 400px; height: 300px; background: #222; margin-top: 16px; }
    .flipped { transform: scaleX(-1); }
    #chat { width: 400px; height: 120px; border: 1px solid #bbb; overflow-y: auto; margin: 0 auto 8px; }
    #input { width: 300px; }
    #timer { font-weight: bold; margin: 16px; }
    #startBtn[disabled] { background: #ccc; }
  </style>
</head>
<body>
  <h2>10분 자유토론(Firebase)</h2>
  <input type="text" id="name" placeholder="이름 입력" />
  <button id="startBtn">토론 시작</button>
  <div id="timer">남은 시간: 10:00</div>
  <video id="video" autoplay muted></video><br>
  <button id="flipBtn">반전</button>
  <div id="chat"></div>
  <input id="input" placeholder="채팅 메세지">
  <button id="sendBtn">전송</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      onValue,
      push,
      child,
      onChildAdded
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ✅ Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyD9qLLToWFFiMKsUNH-DxPLj-ceFVP8Rxg",
      authDomain: "amazi-6de63.firebaseapp.com",
      databaseURL: "https://amazi-6de63-default-rtdb.firebaseio.com",
      projectId: "amazi-6de63",
      storageBucket: "amazi-6de63.appspot.com",
      messagingSenderId: "274825287462",
      appId: "1:274825287462:web:1b1de31d93d7a3e83693e7",
      measurementId: "G-DT4JLH8QEC"
    };

    // ✅ Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const roomRef = ref(db, "room");
    const chatRef = ref(db, "chat");

    const startBtn = document.getElementById('startBtn');
    const video = document.getElementById('video');
    const flipBtn = document.getElementById('flipBtn');
    const timerDiv = document.getElementById('timer');
    const nameInput = document.getElementById('name');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const chatDiv = document.getElementById('chat');

    let time = 600, timer, joined = false, stream;

    // ✅ 토론 상태 실시간 확인
    onValue(child(roomRef, "status"), (snapshot) => {
      const status = snapshot.val();
      if (status === "busy") startBtn.disabled = true;
      else startBtn.disabled = false;
    });

    // ✅ 토론 시작 버튼
    startBtn.onclick = async () => {
      const name = nameInput.value.trim();
      if (!name) {
        alert("이름을 입력하세요!");
        return;
      }

      await set(child(roomRef, "status"), "busy");
      joined = true;
      startBtn.disabled = true;

      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      video.style.display = '';
      time = 600;
      timerDiv.textContent = `남은 시간: 10:00`;

      timer = setInterval(async () => {
        time--;
        const mm = String(Math.floor(time / 60)).padStart(2, '0');
        const ss = String(time % 60).padStart(2, '0');
        timerDiv.textContent = `남은 시간: ${mm}:${ss}`;

        if (time <= 0) {
          clearInterval(timer);
          stream.getTracks().forEach(track => track.stop());
          await set(child(roomRef, "status"), "ready");
          joined = false;
          startBtn.disabled = false;
          timerDiv.textContent = "종료!";
        }
      }, 1000);
    };

    // ✅ 카메라 반전
    flipBtn.onclick = () => video.classList.toggle('flipped');

    // ✅ 채팅 전송
    sendBtn.onclick = () => {
      const name = nameInput.value.trim();
      const msg = input.value.trim();

      if (name && msg) {
        push(chatRef, { name, msg });
        input.value = '';
      }
    };

    // ✅ 채팅 실시간 수신
    onChildAdded(chatRef, (snapshot) => {
      const { name, msg } = snapshot.val();
      chatDiv.innerHTML += `<div><b>${name}:</b> ${msg}</div>`;
      chatDiv.scrollTop = chatDiv.scrollHeight;
    });
  </script>
</body>
</html>
